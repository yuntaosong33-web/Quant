# A股量化交易系统 - 策略配置文件
# ===============================
# 牛市进攻型策略 (Bull Market Offensive Strategy)
# 核心逻辑：动量为王，情绪加速，小市值博弹性

# 数据配置
data:
  # 数据源：统一使用 tushare pro
  data_source: "tushare"
  
  # 股票池: hs300(沪深300), zz500(中证500), zz1000(中证1000), all(全市场)
  # [牛市进攻] 全市场选股，捕捉中小盘和热门股机会
  stock_pool: "all"
  
  # 历史数据开始日期
  start_date: "2020-01-01"
  
  # 每次增量更新的天数（建议至少30天，以支持ROC_20等因子计算）
  update_days: 30
  
  # 数据存储路径
  raw_data_path: "data/raw"
  processed_data_path: "data/processed"
  
  # ===== API调用优化配置（降低超限风险）=====
  # 数据获取模式:
  #   - by_date: 按交易日获取全市场（高效，推荐用于日更）
  #              每个交易日1次API调用，30天数据≈30次调用
  #   - by_stock: 按股票逐只获取（适合回测，需要更长历史）
  #              每只股票2次API调用，5000只股票=10000次调用
  fetch_mode: "by_date"
  
  # 跳过财务指标获取（fina_indicator 接口是逐只股票获取的）
  # 设为 true 时仅使用 daily_basic 的估值数据（PE/PB/市值/换手率）
  # daily_basic 是全市场一次获取，非常高效
  # 如果不需要 ROE 等深层财务指标，建议设为 true 以减少 API 调用
  skip_fina_indicator: false
  
  # 财务指标获取参数（仅当 skip_fina_indicator=false 时生效）
  # 财务指标有7天本地缓存，缓存命中时不调用API
  fina_batch_size: 300      # 每批次处理股票数（越大越快，但超限风险越高）
  fina_batch_sleep: 0.0     # 每批次休息秒数（0=不休息，越小越快，但超限风险越高）

# Tushare 配置
# 获取 Token: https://tushare.pro/register
tushare:
  api_token: "ff84a15bbffab89a99667b3e99fce8aa915077e3b735a5c0b57ff454"
  
  # 缓存目录
  cache_dir: "data/tushare_cache"
  
  # 请求限流（每分钟最大请求数，免费用户约 200，付费用户约 500）
  rate_limit: 200
  
  # 跳过新闻获取（新闻接口有严格限制：每小时2次）
  # 设为 true 时情绪分析会基于股票名称/行业进行，不获取实时新闻
  skip_news: false
  
  # 新闻数据源优先级（当 Tushare 不可用时自动切换）
  # 可选值: "tushare", "akshare", "auto"
  # - tushare: 仅使用 Tushare（需要积分）
  # - akshare: 仅使用 AKShare（免费无限制）
  # - auto: 优先 Tushare，限流时自动切换到 AKShare
  news_source: "auto"

# ============================================================
# 策略配置 - 牛市进攻型策略 (Bull Market Offensive)
# ============================================================
# 核心策略逻辑：
#   1. 动量为核心驱动 (40%)：趋势向上+风险调整收益
#   2. 情绪因子加速 (30%)：LLM分析市场热度，捕捉故事驱动行情
#   3. 小市值博弹性 (20%)：牛市中小盘弹性远大于大盘
#   4. 流动性正向 (10%)：高换手=高人气，而非过热
#   5. 价值因子暂弃 (0%)：牛市不看估值，追逐趋势
# ============================================================
strategy:
  # 策略名称
  name: "Bull Market Offensive"
  
  # ===== 因子权重配置（高波动进攻版）=====
  # 目标：提高组合波动与弹性（偏小盘 + 高波动 + 趋势/情绪），与“银行/低波”反向
  value_weight: 0.0
  quality_weight: 0.35     # 波动率暴露（高波动）
  momentum_weight: 0.55    # 趋势/动量（复合动量）
  size_weight: 0.10        # 降低小盘暴露，避免“过于小盘”
  sentiment_weight: 0.10   # 情绪作为加速器（LLM不稳时会自动降级）
  
  # ===== 选股参数 =====
  top_n: 6                # 持仓6只，分散风险
  min_listing_days: 252   # 至少上市一年（次新股风险较高）
  
  # ===== 风控熔断阈值 =====
  # 恢复合理阈值，防止选入过热股
  turnover_threshold: 3.0    # 换手率Z-Score阈值: Z > 3.0 触发熔断
  volatility_threshold: 2.5  # 波动率阈值: 约 250% 年化波动率
  
  # ===== 板块过滤（账户限制：暂不交易创业板/科创板）=====
  exclude_chinext: true
  exclude_star: true

  # ===== 实盘可交易性过滤（高波动策略：放宽约束）=====
  min_daily_amount: 50000000   # 成交额门槛（元）：抬高以避免微盘/流动性风险
  min_circ_mv: 3000000000      # 流通市值下限（元）：30亿，抑制“过于小盘”
  max_price: null              # 高价股过滤：null=关闭
  max_rsi: 95                  # RSI过滤放宽（或设为 null 关闭）
  min_efficiency: 0.15         # 允许更震荡的票（提高波动）
  overheat_check_col: "turnover_5d_zscore"  # 过热熔断只看换手，避免误用“波动率列”
  
  # ===== 趋势过滤（让持仓更“看得过去”：高波动但要求上行趋势）=====
  trend_filter:
    enabled: true
    require_positive_return_20: true

  # ===== 行业分散与黑名单（降低“押错赛道”与持仓观感）=====
  industry_constraints:
    enabled: true
    # 行业来源：tushare_industry / sw (申万)
    source: "tushare_industry"
    sw_level: 1
    industry_col: "industry"
    max_per_industry: 2
    excluded_industries: []

  # ===== 因子列名映射（高波动进攻）=====
  value_col: "value_composite_zscore"
  quality_col: "volatility_20_zscore"       # 高波动：波动率越高越好（与原“低波”相反）
  momentum_col: "momentum_composite_zscore"
  size_col: "small_cap_zscore"
  
  # ===== 调仓配置 =====
  rebalance_frequency: "weekly"  # 周度调仓（牛市轮动快）
  rebalance_buffer: 0.05         # 5% 缓冲区（减少不必要换手）
  
  # ===== 持股惯性 =====
  holding_bonus: 0.2              # 降低持股惯性加分（牛市积极调仓）

  # ===== Alpha因子开关 (新增) =====
  enable_alpha_factors: true      # 启用 Alpha 因子 (量价配合等)
  
  # ===== 拥挤度轮动开关 =====
  enable_crowding_rotation: true   # 启用拥挤度板块轮动
  crowding_exit_threshold: 0.85    # 行业拥挤度 > 85% 时分批止盈
  crowding_entry_threshold: 0.50   # 行业拥挤度回落到 50% 以下时可切入
  
  # ===== 市场状态自适应配置 =====
  market_regime:
    enabled: true                    # 启用市场状态自适应权重
    trend_ma_period: 60              # 趋势判断: 指数 vs 60日均线
    volatility_period: 20            # 波动率计算周期
    high_volatility_threshold: 0.25  # 25% 年化波动率为高波动
    low_volatility_threshold: 0.15   # 15% 年化波动率为低波动
    # === 自适应权重表（强烈建议显式配置，避免代码默认值与当前行情不一致）===
    # 说明：下面的 bull 配置与本策略“2026年初大盘领涨、换手有效、动量IC为负”的结论对齐
    regime_weights:
      bull:
        value_weight: 0.0
        quality_weight: 0.35
        momentum_weight: 0.55
        size_weight: 0.10
        sentiment_weight: 0.10
      sideways:
        value_weight: 0.05
        quality_weight: 0.35
        momentum_weight: 0.50
        size_weight: 0.10
        sentiment_weight: 0.15
      bear:
        value_weight: 0.10
        quality_weight: 0.25
        momentum_weight: 0.20
        size_weight: 0.45
        sentiment_weight: 0.05
    # === 动态仓位系数（留现金）===
    # bull 也保留“高波动降仓”开关，避免放量后波动扩张导致回撤超预期
    position_scale:
      bull: 1.0
      sideways: 1.0
      bear: 0.70
    high_volatility_position_scale: 1.0

  # ===== 打分归一化（负权重/反向使用时保持信号幅度稳定）=====
  score_normalization:
    normalize_by_abs_weight_sum: true

# ============================================================
# 风险控制配置 - 牛市进攻型参数
# ============================================================
risk:
  # ===== 基础止损止盈 =====
  stop_loss: 0.15         # 15% 止损（放宽止损，让趋势发展）
  take_profit: 0.80       # 80% 止盈（让利润奔跑）
  
  # ===== 组合风险限制 =====
  max_daily_loss: 0.06    # 单日最大亏损 6%（牛市波动大）
  max_drawdown: 0.25      # 最大回撤限制 25%（容忍更大回撤）
  
  # ===== ATR 动态止损配置 =====
  use_atr_stop_loss: true       # 启用 ATR 止损
  atr_period: 14                # ATR 计算周期（14日）
  atr_multiplier: 4.0           # ATR 止损倍数（放宽到4倍）
  atr_trailing: true            # 启用移动止损（跟踪盈利）
  
  # ===== 大盘风控参数 =====
  # 规则：跌破60日均线 且 20日跌幅超过10% 时触发清仓
  market_risk:
    enabled: true         # 启用大盘风控
    ma_period: 60         # 60日均线
    drop_threshold: 0.10  # 10% 跌幅阈值（牛市容忍度更高）
    drop_lookback: 20     # 回溯20日计算跌幅

# 投资组合配置 - 集中持仓型
portfolio:
  # 总资金（元）
  total_capital: 300000
  
  # 单只股票最大权重（8只股票，最大约15%）
  max_weight: 0.18
  
  # 单只股票最小权重
  min_weight: 0.0
  
  # 无风险利率
  risk_free_rate: 0.02
  
  # 优化目标: max_sharpe(最大夏普比率), min_volatility(最小波动率), equal_weight(等权重)
  # 牛市使用等权重分配，降低优化复杂度
  optimization_objective: "equal_weight"
  
  # 协方差压缩方法: ledoit_wolf, oracle_approximating, exponential
  shrinkage_type: "ledoit_wolf"
  
  # 预期收益率计算方法: mean_historical, ema_historical
  returns_method: "mean_historical"
  
  # 协方差计算回溯天数
  lookback_days: 252

# LLM 情绪分析配置
llm:
  # 提供商: qwen (阿里云通义千问)
  provider: "qwen"
  
  # 主模型名称
  model: "qwen3-max"
  
  # 备用模型（主模型失败时自动降级）
  fallback_model: "qwen-turbo"
  
  # API 端点 (阿里云 DashScope OpenAI 兼容模式)
  base_url: "https://dashscope.aliyuncs.com/compatible-mode/v1"
  
  # API Key
  api_key: "sk-a4eee1b50b9341c4a3f4f9abefe7460d"
  
  # 是否启用情绪分析
  enable_sentiment_filter: true
  
  # 情绪分数阈值（用于极端负面情况的安全过滤）
  # [牛市进攻] 降低阈值，仅过滤极端负面
  sentiment_threshold: -0.7
  
  # ===== 缓存配置 =====
  cache_path: "data/processed/sentiment_cache.json"
  cache_ttl_days: 7
  
  # ===== API 配置 =====
  request_timeout: 30
  max_retries: 3
  max_concurrent: 5
  
  # ===== 提示词配置 =====
  detailed_prompts: true
  
  # ===== 熔断器与置信度配置 =====
  max_consecutive_failures: 5
  min_confidence: 0.6       # 降低置信度要求
  sentiment_buffer_multiplier: 5

# 交易配置
trading:
  # 交易费用（双边）- 标准A股费率
  commission_rate: 0.0003
  
  # 印花税（卖出时）
  stamp_duty: 0.001
  
  # 滑点比例
  slippage: 0.001
  
  # 最小交易单位（股）
  min_trade_unit: 100
  
  # 最小交易金额（低于此金额的订单会被过滤，减少不必要交易）
  min_trade_amount: 10000
  
  # 最大冲击比率（订单金额/日成交额，超过则标记为不可执行）
  max_impact_ratio: 0.05

# 报告配置
report:
  # 报告格式: markdown, html
  format: "html"
  
  # 报告输出目录
  output_dir: "reports"
  
  # 是否发送邮件通知
  send_email: false
  
  # 邮件配置
  email:
    smtp_server: ""
    smtp_port: 587
    sender: ""
    password: ""
    recipients: []

# 消息推送配置
notification:
  # PushPlus 微信推送 (http://www.pushplus.plus/)
  pushplus_token: "c71a6a03122e41e3b0b691693748c0ce"
  
  # 是否启用推送
  enabled: true
  # 可选：群组/topic（PushPlus 群组推送时使用）
  topic: ""
  # 可选：通道（PushPlus 支持的 channel 参数）
  channel: ""
  # 请求超时与重试
  timeout: 30
  max_retries: 3

# 日志配置
logging:
  # 日志级别: DEBUG, INFO, WARNING, ERROR
  level: "INFO"
  
  # 日志文件目录
  log_dir: "logs"
  
  # 日志文件保留天数
  retention_days: 30

# 回测配置
backtest:
  # 回测开始日期
  start_date: "2024-01-01"
  
  # 回测结束日期
  end_date: "2025-01-01"
  
  # 初始资金
  initial_capital: 300000
  
  # 基准指数
  # [牛市进攻] 使用中证1000作为基准（小盘股基准）
  benchmark: "000852"

  # 回测最大股票数量
  max_stocks: 500

# 因子 IC 监控配置
ic_monitor:
  # 是否启用IC监控
  enabled: true
  
  # 前瞻收益窗口（交易日）
  lookback_days: 5
  
  # IC 采样天数（减少内存占用，默认30天）
  sample_days: 30
  
  # 日志频率: daily, weekly
  log_frequency: "daily"
  
  # 是否集成到每日报告
  report_integration: true
  
  # IC有效性阈值（IC > 0.03 视为有效因子）
  ic_threshold: 0.03
  
  # 因子失效熔断配置
  # 注意: 使用绝对值判断，IC为负表示因子方向相反，仍有预测力
  circuit_breaker_enabled: true    # 是否启用因子熔断
  circuit_breaker_ic_threshold: 0.005  # |IC| 低于此值触发熔断（接近无预测力）
  circuit_breaker_ir_threshold: 0.2    # |IC_IR| 低于此值触发熔断（不稳定）

  # ===== 方向校准（IC为负时反向使用）=====
  directional_adjustment:
    enabled: true
    abs_ic_threshold: 0.02
    ir_threshold: 0.3
    positive_ratio_threshold: 0.55
  
  # 监控的因子列表
  monitored_factors:
    # 高波动策略：优先监控“技术面可用且无前视偏差”的因子
    - "momentum_composite_zscore"
    - "volatility_20_zscore"
    - "turnover_5d_zscore"
    - "efficiency_20_zscore"

# 交易日历配置
trading_calendar:
  # 是否启用交易日历校验
  check_enabled: true
  # 交易所代码 (XSHG=上交所, XSHE=深交所)
  exchange: "XSHG"

# 动态滑点配置
slippage:
  # 滑点模式: "fixed" 或 "dynamic"
  mode: "dynamic"
  # 固定滑点 (mode=fixed时使用)
  fixed_slippage: 0.001
  # 基础滑点 (mode=dynamic时使用)
  base_slippage: 0.001
  # 市场冲击系数 (平方根冲击模型)
  impact_coefficient: 0.1
  # 最大滑点上限
  max_slippage: 0.02

# 持仓偏移检测配置
position_drift:
  # 是否启用偏移检测
  check_enabled: true
  # 累计偏移阈值，超过此值强制调仓
  max_drift: 0.15

# 历史业绩记录配置
performance_history:
  # 是否启用历史记录
  enabled: true
  # 保留最近多少天
  max_days: 365
  # 历史记录文件路径
  file_path: "data/processed/performance_history.json"
